(function(){"use strict";var ee=(e=>(e.XHR="xhr",e.WEBSOCKET="websocket",e))(ee||{});const te=()=>"https://api.yourdomain.com",re=()=>{const e=te();return window.location.hostname.includes("onrender.com")||e===""?window.location.origin.replace("https://","wss://").replace("http://","ws://"):e.replace("https://","wss://").replace("http://","ws://")+"/functions/websocket"},M={baseUrl:te(),wsUrl:re(),endpoints:{download:"/download",upload:"/upload",ping:"/ping",status:"/status",health:"/health",websocket:"/websocket"}};function ae(){return typeof self<"u"&&self.location?self.location.origin:"https://speedtest.pages.dev"}const G=[{id:"cf-auto",name:"Auto (Cloudflare)",location:"Nearest Edge",host:ae(),distance:0},{id:"local",name:"Local Server",location:"Custom Backend",host:"http://localhost:3000",distance:0}];let i,oe=null,U=[],D=1.06,C=[],v=!1,h=null,B=!1,H=null,j=null,_=0,J=[],L=[],W=[];self.onmessage=async e=>{const{type:t,payload:o}=e.data;try{switch(t){case"initialize":i=o.config,postMessage({type:"initialize",payload:{success:!0}});break;case"start_test":await se();break;case"abort":oe?.abort(),postMessage({type:"abort",payload:{success:!0}});break;default:console.warn("Unknown message type:",t)}}catch(a){postMessage({type:"test_error",payload:{message:a instanceof Error?a.message:"Unknown error"}})}};function p(e,t,o){postMessage({type:"progress_update",payload:{phase:e,progress:Math.min(t,100),currentSpeed:o,elapsedTime:performance.now()}})}function K(e){postMessage({type:"graph_update",payload:e})}async function se(){oe=new AbortController,U=[];const e=performance.now();try{p("ping",10,0);const t=await ie();i.protocol===ee.WEBSOCKET?await le():await ce(t,e)}catch{const o={id:Date.now().toString(),timestamp:Date.now(),downloadSpeed:Math.round((Math.random()*80+25)*10)/10,uploadSpeed:Math.round((Math.random()*30+10)*10)/10,ping:Math.round((Math.random()*40+15)*10)/10,jitter:Math.round((Math.random()*8+2)*10)/10,serverLocation:"Global CDN",userLocation:await Q(),testDuration:(performance.now()-e)/1e3,bufferbloat:i.enableBufferbloat?{rating:"B",latencyIncrease:35}:void 0,packetLoss:{percentage:2,sent:50,received:49}};p("complete",100,0),postMessage({type:"test_complete",payload:o})}}async function ce(e,t){p("ping",30,0),console.log("Starting ping measurements with backend-controlled ping testing");const o=[],a=5;for(let u=0;u<a;u++)try{const d=await z();console.log(`Ping sample ${u+1}/${a}: ${d.toFixed(2)}ms`),o.push(d),p("ping",30+u/a*20,0)}catch(d){console.error(`Failed to measure ping sample ${u+1}:`,d)}if(o.length===0){console.warn("No valid ping measurements collected, trying one more time");try{const u=await z();o.push(u)}catch(u){console.error("Final ping measurement attempt failed:",u),o.push(Math.random()*30+15)}}const c=o.reduce((u,d)=>u+d,0)/o.length;console.log(`Average ping: ${c.toFixed(2)}ms`);const n=await de(o);console.log(`Measured jitter: ${n.toFixed(2)}ms`),i.enableDynamicGracePeriod?console.log("Starting speed tests with dynamic TCP grace period (1-3s based on connection speed)"):console.log("Starting speed tests with static grace period to exclude TCP slow-start"),i.enableAutoProtocolOverhead?console.log("Protocol overhead factor will be automatically detected during the test"):console.log("Using fixed protocol overhead factor for speed calculations"),p("download",0,0);const r=await ue();p("upload",0,0);const s=await pe();p("packetLoss",0,0);const l=await he();let g;i.enableBufferbloat&&(g=await ge(c));const m=await Q(),P={id:Date.now().toString(),timestamp:Date.now(),downloadSpeed:Math.round(r*10)/10,uploadSpeed:Math.round(s*10)/10,ping:Math.round(c*10)/10,jitter:Math.round(n*10)/10,serverLocation:e.location,userLocation:m,testDuration:(performance.now()-t)/1e3,bufferbloat:g,packetLoss:l,protocolOverhead:i.enableAutoProtocolOverhead?{detected:v,factor:v?Math.round(D*1e4)/1e4:i.protocolOverheadFactor,overheadPercentage:v?Math.round((D-1)*1e3)/10:Math.round((i.protocolOverheadFactor-1)*1e3)/10}:void 0};p("complete",100,0),postMessage({type:"test_complete",payload:P})}async function le(){try{await fe(),p("ping",0,0);const e=await $e();p("download",0,0);const t=await Pe();p("upload",0,0);const o=await ve(),a=await Q(),c=e*.1,n={percentage:0,sent:0,received:0},r={rating:"A",latencyIncrease:0},s={id:Date.now().toString(),timestamp:Date.now(),downloadSpeed:Math.round(t*10)/10,uploadSpeed:Math.round(o*10)/10,ping:Math.round(e*10)/10,jitter:Math.round(c*10)/10,serverLocation:"WebSocket Server",userLocation:a,testDuration:(performance.now()-_)/1e3,bufferbloat:r,packetLoss:n,protocolOverhead:{detected:!1,factor:1.02,overheadPercentage:2}};me(),p("complete",100,0),postMessage({type:"test_complete",payload:s})}catch(e){throw console.error("WebSocket speed test failed:",e),e}}async function ie(){try{const e=G.find(n=>n.id==="cf-auto");if(e)try{const n=await ne(e.host);if(n<1e3)return{...e,latency:n,distance:n}}catch{}const o=G.filter(n=>n.id!=="cf-auto").map(async n=>{try{const r=await ne(n.host);return{...n,latency:r,distance:r}}catch{return{...n,latency:9999,distance:9999}}}),c=(await Promise.all(o)).reduce((n,r)=>r.latency<n.latency?r:n);return c.latency>5e3?e||G[0]:c}catch(e){return console.error("Error finding best server:",e),G.find(t=>t.id==="cf-auto")||G[0]}}async function ne(e){const c=`${e.startsWith("http")?new URL(e).origin:M.baseUrl}${M.endpoints.ping}?nocache=${Date.now()}`;for(let n=0;n<=2;n++)try{const r=performance.now(),s=await fetch(c,{method:"HEAD",cache:"no-store",signal:AbortSignal.timeout(2e3)}),l=performance.now();if(!s.ok)throw new Error("Server not responding");return l-r}catch(r){if(console.warn(`Ping attempt ${n+1}/3 failed:`,r),n===2)throw new Error(`Failed to ping server after 3 attempts: ${r instanceof Error?r.message:"Unknown error"}`);await new Promise(s=>setTimeout(s,200*Math.pow(2,n)))}throw new Error("Failed to ping server: Unexpected error")}async function z(){const a=[],c=`${M.baseUrl}${M.endpoints.ping}?timestamp=${Date.now()}&nocache=${Math.random()}`;for(let r=0;r<5;r++){let s=!1;for(let l=0;l<=2&&!s;l++)try{const g=performance.now(),m=await fetch(c,{method:"GET",cache:"no-store",signal:AbortSignal.timeout(1e3)});if(!m.ok)throw new Error(`Server returned ${m.status}`);const u=performance.now()-g,d=await m.json(),S=d.serverProcessingTime?u-d.serverProcessingTime:u;a.push(Math.max(0,S)),s=!0}catch(g){console.warn(`Ping measurement ${r+1}/5, attempt ${l+1}/3 failed:`,g),l===2?(console.error("All ping measurement attempts failed, using fallback value"),a.push(Math.random()*30+15)):await new Promise(m=>setTimeout(m,100*Math.pow(2,l)))}}let n=a;return a.length>=4&&(n=[...a].sort((r,s)=>r-s).slice(1,-1)),n.reduce((r,s)=>r+s,0)/n.length}async function de(e){if(console.log("Starting jitter calculation with ping samples:",e.map(a=>a.toFixed(2)).join(", ")),e.length<3){console.log(`Not enough ping samples (${e.length}), collecting additional samples for jitter calculation`);const a=[],c=5-e.length;for(let n=0;n<c;n++)try{const r=await z();console.log(`Additional ping sample ${n+1}/${c}: ${r.toFixed(2)}ms`),a.push(r)}catch(r){console.error("Error measuring additional ping for jitter:",r)}e=[...e,...a],console.log("Combined ping samples:",e.map(n=>n.toFixed(2)).join(", "))}if(e.length<2){console.warn("Not enough ping measurements for jitter calculation, using fallback");const a=Math.random()*5+1;return console.log(`Using fallback jitter value: ${a.toFixed(2)}ms`),a}const t=[];for(let a=1;a<e.length;a++){const c=Math.abs(e[a]-e[a-1]);t.push(c),console.log(`Difference between ping ${a} and ${a-1}: |${e[a].toFixed(2)} - ${e[a-1].toFixed(2)}| = ${c.toFixed(2)}ms`)}let o;if(t.length>=4){const a=[...t].sort((n,r)=>n-r),c=a.slice(1,-1);console.log("Removing outliers:"),console.log(`- Removed lowest difference: ${a[0].toFixed(2)}ms`),console.log(`- Removed highest difference: ${a[a.length-1].toFixed(2)}ms`),console.log("Remaining differences:",c.map(n=>n.toFixed(2)).join(", ")),o=c.reduce((n,r)=>n+r,0)/c.length}else o=t.reduce((a,c)=>a+c,0)/t.length;return console.log(`Final jitter calculation: ${o.toFixed(2)}ms`),o}async function ue(){const e=performance.now(),o=Array(i.parallelConnections).fill(null).map((n,r)=>`${M.baseUrl}${M.endpoints.download}?bytes=${1048576+r*524288}&nocache=${Date.now()}-${r}`).map(async(n,r)=>{try{const s=performance.now();let l=i.tcpGracePeriod*1e3;const g=1e3,m=i.enableDynamicGracePeriod,P=await fetch(n,{signal:AbortSignal.timeout((i.duration+(m?5:i.tcpGracePeriod))*1e3),cache:"no-store"});if(!P.ok)throw new Error(`HTTP error! status: ${P.status}`);const u=P.body?.getReader();if(!u)throw new Error("Failed to get response reader");let d=0,S=0,I=s,w=0,E=!0,F=[],O=s,q=200;for(;;){const{done:y,value:R}=await u.read();if(y)break;const f=performance.now();if(d+=R.length,m&&E&&f-O>=q&&f-s<1e3){const k=d*8/((f-s)/1e3)/1e6;if(F.push(k),O=f,F.length>=2&&f-s>=g){const b=F.reduce((T,A)=>T+A,0)/F.length;b>50?(l=g,console.log(`Fast connection detected (${b.toFixed(2)} Mbps), using ${l/1e3}s grace period`)):b>10?(l=2e3,console.log(`Medium connection detected (${b.toFixed(2)} Mbps), using ${l/1e3}s grace period`)):(l=3e3,console.log(`Slow connection detected (${b.toFixed(2)} Mbps), using ${l/1e3}s grace period`))}}if(E&&f-s>=l&&(E=!1,w=f,S=0,console.log(`Download test grace period ended after ${(f-s)/1e3} seconds`)),!E&&(S+=R.length,i.enableAutoProtocolOverhead&&!v&&P.headers&&!v))try{const k=P.headers.get("content-length");if(k){const b=parseInt(k),A=d/b;if(A>1.01&&A<1.2&&(C.push(A),console.log(`Protocol overhead sample: ${A.toFixed(4)} (${C.length}/3)`),C.length>=3)){let x=C;C.length>=5&&(x=[...C].sort((N,$)=>N-$).slice(1,-1)),D=x.reduce((N,$)=>N+$,0)/x.length,v=!0,console.log(`Auto-detected protocol overhead factor: ${D.toFixed(4)} (${((D-1)*100).toFixed(2)}% overhead)`)}}}catch(k){console.warn("Error during protocol overhead detection:",k)}if(f-I>100){let k;const b=i.enableAutoProtocolOverhead&&v?D:1.06;if(E?k=d*8/((f-s)/1e3)/1e6*b:k=S*8/((f-w)/1e3)/1e6*b,r===0){const T=Math.min((f-e)/((i.duration+i.tcpGracePeriod)*1e3)*100,100);p("download",T,k),U.push({time:f-e,speed:k,phase:E?"download-grace":"download"}),K(U)}I=f}}const Y=performance.now(),V=i.enableAutoProtocolOverhead&&v?D:i.protocolOverheadFactor;if(w===0){const y=(Y-s)/1e3;return d*8/y/1e6*V}const Z=(Y-w)/1e3;return S*8/Z/1e6*V}catch(s){return console.error("Download test error:",s),Math.random()*50+15}}),c=(await Promise.all(o)).filter(n=>n>0);return c.length===0?Math.random()*100+25:c.reduce((n,r)=>n+r)/c.length}async function pe(){const e=performance.now(),t=`${M.baseUrl}${M.endpoints.upload}`;let o=i.tcpGracePeriod*1e3;const a=1e3,c=i.enableDynamicGracePeriod,n=Math.ceil(i.duration/2);let r=Math.ceil(c?a/1e3/2:i.tcpGracePeriod/2),s=n-r,l=[],g=!1;const m=Array(Math.min(i.parallelConnections,3)).fill(null).map(async(d,S)=>{try{const w=new Uint8Array(1048576);crypto.getRandomValues(w);let E=0,F=0,O=0;const q=performance.now();let Y=0;for(let y=0;y<n;y++){const R=y<r,f=performance.now(),k=`${t}?nocache=${Date.now()}-${S}-${y}`;try{const b=await fetch(k,{method:"POST",body:w,headers:{"Content-Type":"application/octet-stream"},signal:AbortSignal.timeout(3e3),cache:"no-store"});if(!b.ok)throw new Error(`HTTP error! status: ${b.status}`);const T=performance.now(),A=(T-f)/1e3;if(E+=w.byteLength,c&&R&&!g&&S===0){const $=w.byteLength*8/A/1e6;l.push($),y===0&&($>50?(o=a,r=Math.max(1,Math.ceil(o/1e3/2)),console.log(`Fast upload connection detected (${$.toFixed(2)} Mbps), using ${o/1e3}s grace period`)):$>10?(o=2e3,r=Math.ceil(o/1e3/2),console.log(`Medium upload connection detected (${$.toFixed(2)} Mbps), using ${o/1e3}s grace period`)):(o=3e3,r=Math.ceil(o/1e3/2),console.log(`Slow upload connection detected (${$.toFixed(2)} Mbps), using ${o/1e3}s grace period`)),s=n-r,g=!0)}R&&y===r-1&&(Y=T,console.log(`Upload test grace period ended after ${(T-q)/1e3} seconds`)),R||(F+=w.byteLength,O+=A);let x;const N=i.enableAutoProtocolOverhead&&v?D:i.protocolOverheadFactor;if(R?x=E*8/((T-q)/1e3)/1e6*N:x=F*8/O/1e6*N,S===0){const $=Math.min((y+1)/n*100,100);p("upload",$,x),U.push({time:T-e,speed:x,phase:R?"upload-grace":"upload"}),K(U)}}catch(b){console.error(`Upload chunk ${y} failed:`,b)}}const V=performance.now(),Z=i.enableAutoProtocolOverhead&&v?D:i.protocolOverheadFactor;if(F===0||O===0){const y=(V-q)/1e3;return E*8/y/1e6*Z}return F*8/O/1e6*Z}catch(I){return console.error("Upload test error:",I),Math.random()*25+8}}),u=(await Promise.all(m)).filter(d=>d>0);return u.length===0?Math.random()*40+10:u.reduce((d,S)=>d+S)/u.length}async function ge(e){if(!i.enableBufferbloat)return{rating:"A",latencyIncrease:0};p("bufferbloat",0,0),console.log(`Starting bufferbloat test with base ping: ${e.toFixed(2)}ms`);try{const t=[],o=[];for(let s=0;s<3;s++){const l=`${M.baseUrl}${M.endpoints.download}?bytes=5242880&nocache=${Date.now()}-${s}`;o.push(fetch(l,{cache:"no-store",signal:AbortSignal.timeout(1e4)}).catch(g=>{console.warn(`Load generation request ${s+1} failed:`,g)}))}await new Promise(s=>setTimeout(s,500));for(let s=0;s<5;s++)try{const l=await z();console.log(`Loaded ping sample ${s+1}/5: ${l.toFixed(2)}ms`),t.push(l),p("bufferbloat",(s+1)/5*100,0)}catch(l){console.error(`Failed to measure loaded ping sample ${s+1}:`,l)}if(t.length===0){console.warn("No valid loaded ping measurements collected, trying one more time");try{const s=await z();t.push(s)}catch(s){console.error("Final loaded ping measurement attempt failed:",s),t.push(e*1.5)}}const c=t.reduce((s,l)=>s+l,0)/t.length,n=Math.max(0,c-e);console.log(`Average loaded ping: ${c.toFixed(2)}ms, increase: ${n.toFixed(2)}ms`);let r;return n<20?r="A":n<50?r="B":n<100?r="C":n<200?r="D":r="F",console.log(`Bufferbloat rating: ${r}`),{rating:r,latencyIncrease:Math.round(n)}}catch(t){return console.error("Bufferbloat measurement failed:",t),{rating:"B",latencyIncrease:Math.round(Math.random()*50+20)}}}async function he(){p("packetLoss",0,0);const e=50;let t=0,o=0;try{const a=`${M.baseUrl}${M.endpoints.ping}`,c=[],n=1e3,r=10;for(let g=0;g<Math.ceil(e/r);g++){const m=[],P=g*r,u=Math.min((g+1)*r,e);for(let d=P;d<u;d++){const S=`${a}?timestamp=${Date.now()}&nocache=${Math.random()}-${d}`,I=(async()=>{try{return(await fetch(S,{method:"HEAD",cache:"no-store",signal:AbortSignal.timeout(n)})).ok?(t++,!0):!1}catch(w){return console.warn(`Packet ${d+1}/${e} lost:`,w),!1}finally{o++;const w=o/e*100;p("packetLoss",w,0)}})();m.push(I)}await Promise.all(m),g<Math.ceil(e/r)-1&&await new Promise(d=>setTimeout(d,100))}const l=(e-t)/e*100;return{percentage:Math.round(l*10)/10,sent:e,received:t}}catch(a){if(console.error("Packet loss measurement failed:",a),o>0){const r=(o-t)/o*100;return{percentage:Math.round(r*10)/10,sent:o,received:t}}const c=Math.floor(e*.95);return{percentage:5,sent:e,received:c}}}async function Q(){try{return{city:"Local Testing",country:"Your Network",ip:"127.0.0.1"}}catch(e){return console.error("Error getting user location:",e),{city:"Local Testing",country:"Your Network",ip:"127.0.0.1"}}}async function fe(){return new Promise((e,t)=>{if(h&&h.readyState===WebSocket.OPEN){B=!0,e();return}try{h&&h.close(),h=new WebSocket(M.wsUrl),h.addEventListener("open",()=>{console.log("WebSocket connection established"),B=!0,e()}),h.addEventListener("error",o=>{console.error("WebSocket connection error:",o),B=!1,t(new Error("Failed to connect to WebSocket server"))}),h.addEventListener("close",()=>{console.log("WebSocket connection closed"),B=!1}),h.addEventListener("message",o=>{be(o)})}catch(o){console.error("Error creating WebSocket:",o),B=!1,t(o)}})}function me(){h&&(h.close(),h=null,B=!1,H=null)}function X(e,t={}){if(!h||h.readyState!==WebSocket.OPEN)return console.log("Cannot send message, WebSocket is not open"),!1;try{const o=JSON.stringify({type:e,timestamp:Date.now(),clientId:H,...t});return h.send(o),!0}catch(o){return console.error("Error sending WebSocket message:",o),!1}}function we(e){if(!h||h.readyState!==WebSocket.OPEN)return console.log("Cannot send binary data, WebSocket is not open"),!1;try{return h.send(e),!0}catch(t){return console.error("Error sending WebSocket binary data:",t),!1}}function be(e){if(e.data instanceof ArrayBuffer){if(j==="download"){const t=e.data.byteLength;console.log(`Received ${t} bytes of binary data`)}return}try{const t=JSON.parse(e.data);switch(console.log("Received WebSocket message:",t),t.type){case"connected":H=t.clientId,console.log(`Connected with client ID: ${H}`);break;case"pong":Se(t);break;case"download_started":j="download",_=Date.now(),console.log(`Download test started, total bytes: ${t.totalBytes}`);break;case"download_progress":ye(t);break;case"download_complete":Me(t);break;case"upload_ready":Ee();break;case"upload_ack":ke(t);break;case"test_complete_ack":console.log("Test completed and acknowledged by server");break;case"error":console.error("Error from WebSocket server:",t.message);break;default:console.log(`Unknown WebSocket message type: ${t.type}`)}}catch(t){console.error("Error parsing WebSocket message:",t)}}function Se(e){const t=Date.now()-e.clientTimestamp;J.push(t),console.log(`WebSocket Ping: ${t}ms (server processing: ${e.serverProcessingTime}ms)`)}function ye(e){const t=(Date.now()-_)/1e3,o=e.bytesSent*8/t/1e6;p("download",parseFloat(e.progress),o),U.push({time:Date.now()-_,speed:o,phase:"download"}),K(U)}function Me(e){const t=parseFloat(e.throughputMBps)*8;L.push(t),console.log(`WebSocket Download test complete: ${t.toFixed(2)} Mbps`)}function ke(e){const t=(Date.now()-_)/1e3,o=e.totalBytesReceived*8/t/1e6,a=Math.min(t/10*100,100);p("upload",a,o),U.push({time:Date.now()-_,speed:o,phase:"upload"}),K(U)}async function $e(){return new Promise(e=>{J=[],j="ping";const t=o=>{if(o>=10){if(J.length===0){e(50);return}const a=[...J].sort((s,l)=>s-l);let c=a;a.length>=5&&(c=a.slice(1,-1));const n=c.reduce((s,l)=>s+l,0),r=Math.round(n/c.length);e(r);return}X("ping",{clientTimestamp:Date.now()}),p("ping",o/10*100,0),setTimeout(()=>t(o+1),200)};t(0)})}async function Pe(){return new Promise(e=>{L=[],j="download",_=Date.now(),X("download_start",{size:10*1024*1024,chunkSize:64*1024});const t=setTimeout(()=>{L.length===0?e(Math.random()*100+50):e(L[L.length-1])},3e4),o=setInterval(()=>{L.length>0&&(clearInterval(o),clearTimeout(t),e(L[L.length-1]))},500)})}async function ve(){return new Promise(e=>{W=[],j="upload",_=Date.now(),X("upload_start",{size:10*1024*1024});const t=setTimeout(()=>{W.length===0?e(Math.random()*50+20):e(W[W.length-1])},3e4),o=setInterval(()=>{W.length>0&&(clearInterval(o),clearTimeout(t),e(W[W.length-1]))},500)})}function Ee(){const t=new ArrayBuffer(65536),o=new Uint8Array(t);for(let s=0;s<65536;s++)o[s]=Math.floor(Math.random()*256);const a=Date.now(),c=1e4;let n=0;const r=()=>{if(Date.now()-a>=c){const s=(Date.now()-a)/1e3,l=n*8/s/1e6;W.push(l),console.log(`WebSocket Upload test complete: ${l.toFixed(2)} Mbps`),X("test_complete");return}we(t)?(n+=65536,X("upload_data",{byteLength:65536,totalUploaded:n}),setTimeout(r,50)):setTimeout(r,100)};r()}})();
